<!-- Fondo oscuro -->
<div class="fixed inset-0 bg-black/60 z-40" (click)="onCerrarClick()"></div>

<!-- Contenido del Modal -->
<div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 w-full max-w-3xl">
  
  <div class="bg-white rounded-lg shadow-xl max-h-[90vh] flex flex-col">
    
    <!-- Encabezado -->
    <div class="flex justify-between items-center p-4 border-b">
      <h3 class="text-xl font-bold text-gray-800">Registrar Nueva Venta</h3>
      <button (click)="onCerrarClick()" class="text-gray-400 hover:text-gray-600 font-bold p-2 rounded-full leading-none">
        X
      </button>
    </div>

    <!-- Cuerpo del Formulario -->
    <div class="overflow-y-auto">
      <form [formGroup]="ventaForm" (ngSubmit)="guardarVenta()" class="p-6 space-y-6">
        
        <!-- Campo Cliente -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Cliente</label>
          <input type="text" formControlName="cliente" 
                 class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
        </div>

        <!-- Lista de Productos -->
        <div class="border-t pt-4">
          <h4 class="text-lg font-medium text-gray-800 mb-3">Productos</h4>
          
          <div formArrayName="productos" class="space-y-3">
            
            <!-- Encabezados -->
            <div class="grid grid-cols-12 gap-3 text-xs font-bold text-gray-500 px-3">
              <div class="col-span-5">Producto</div>
              <div class="col-span-2 text-center">Cantidad</div>
              <div class="col-span-2 text-center">Precio U.</div>
              <div class="col-span-2 text-center">Subtotal</div>
              <div class="col-span-1"></div>
            </div>

            <!-- Filas de Productos -->
            <div *ngFor="let producto of productos.controls; let i = index" 
                 [formGroupName]="i" 
                 class="grid grid-cols-12 gap-3 p-3 bg-gray-50 rounded-lg items-center">
              
              <!-- Selector de Producto -->
              <div class="col-span-5">
                <select formControlName="productoId" (change)="onProductoSeleccionado(i, $event)"
                        class="block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm">
                  <option value="" disabled>Selecciona un producto...</option>
                  <!-- **CAMBIO:** Se usa `p._id` para el valor y `p.desc_queso` para el texto -->
                  <option *ngFor="let p of productosDisponibles" [value]="p._id">{{ p.desc_queso }}</option>
                </select>
              </div>

              <!-- Cantidad -->
              <div class="col-span-2">
                <input type="number" formControlName="cantidad" class="block w-full rounded-md border-gray-300 shadow-sm p-2 text-center">
              </div>

              <!-- Precio Unitario (solo lectura) -->
              <div class="col-span-2">
                <input type="number" formControlName="precioUnitario" class="block w-full rounded-md border-gray-300 shadow-sm p-2 text-center bg-gray-200" readonly>
              </div>

              <!-- Subtotal (solo lectura) -->
              <div class="col-span-2">
                <input type="number" formControlName="subtotal" class="block w-full rounded-md border-gray-300 shadow-sm p-2 text-center bg-gray-200" readonly>
              </div>

              <!-- BotÃ³n Quitar -->
              <div class="col-span-1 text-center">
                <button type="button" (click)="quitarProducto(i)" class="text-red-500 hover:text-red-700 font-bold p-2">X</button>
              </div>
            </div>
          </div>

          <button type="button" (click)="agregarProducto()" 
                  class="mt-4 bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200">
            + Agregar Producto
          </button>
        </div>
      </form>
    </div>
    
    <!-- Pie del Modal -->
    <div class="flex justify-between items-center p-4 border-t bg-gray-50 rounded-b-lg">
      <div class="text-xl font-bold">Total: <span class="text-green-600">{{ totalVenta | currency }}</span></div>
      <div class="space-x-3">
        <button type="button" (click)="onCerrarClick()" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
        <button type="submit" (click)="guardarVenta()" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">Guardar Venta</button>
      </div>
    </div>

  </div>
</div>
